#!/usr/bin/env bash
set -e

# this script helps download youtube videos and playlists with my preferred options.

if [[ -z "$1" ]]; then
  echo "Usage:"
  echo "  yt-get.sh [--list-only] PLAYLIST_ID"
  echo "  yt-get.sh VIDEO_ID"
  exit 1
fi

# Check for optional --list-only flag
LIST_ONLY=0
if [[ "$1" == "--list-only" ]]; then
  LIST_ONLY=1
  shift
fi

ID="$1"

COMMON_OPTS=(
  --sub-langs "en,ja"				# download subs in english and japanese
  --write-subs						# download existing subtitles
  --write-auto-subs					# download automatically generated subtitles
  --sub-format srt					# use srt format for subtitles
  --embed-metadata					# embeds metadata and thumbnail into the downloaded file
  -f "bv*+ba/b"						# download best video and best audio and merge, grab best single file as fall back
  --merge-output-format mkv			# ensure merge to mkv 
  --write-thumbnail					# save the thumbnail to a file 
  --convert-thumbnails jpg			# convert it to png if another format 
  --embed-thumbnail					# embed the thumbnail in the file as well 
  --cookies-from-browser firefox	# use firefox cookies 
  --write-info-json					# save all metadata
)

# Heuristic:
# Playlist IDs usually start with PL, OL, UU, FL, RD, etc.
# Video IDs are 11 chars long.
if [[ "$ID" =~ ^(PL|OL|UU|FL|RD) ]]; then
  #PLAYLIST_NAME=$(yt-dlp --flat-playlist --print "%(playlist_title)s" $ID)
  PLAYLIST_NAME=$(yt-dlp --flat-playlist --playlist-items 1 --print "%(playlist_title)s" "$ID")

  echo "▶ Detected playlist: $ID, name: $PLAYLIST_NAME"

  mkdir -p "$PLAYLIST_NAME"

  # Create a text file with video title, ID, and URL
  TXT_FILE="${PLAYLIST_NAME}/playlist_${ID}_videos.txt"
  echo "Generating video list: $TXT_FILE"
  yt-dlp -i --flat-playlist --print "%(title)s|%(id)s|%(webpage_url)s" $ID > $TXT_FILE

  echo "▶ Video list saved to $TXT_FILE"
  if [[ $LIST_ONLY -eq 0 ]]; then
	  yt-dlp \
		-o "%(playlist_title)s/%(playlist_index)02d - %(title)s/%(title)s.%(ext)s" \
		"${COMMON_OPTS[@]}" \
		"https://www.youtube.com/playlist?list=$ID"
  else
    echo "▶ List-only mode enabled. Skipping video downloads."
  fi	

elif [[ ${#ID} -eq 11 ]]; then
  echo "▶ Detected single video: $ID"

  yt-dlp \
    -o "%(title)s/%(title)s.%(ext)s" \
    "${COMMON_OPTS[@]}" \
    "https://www.youtube.com/watch?v=$ID"

else
  echo "❌ Could not determine whether this is a playlist or video ID."
  echo "ID provided: $ID"
  exit 1
fi

